ðŸ“˜ This documentation is also available in [Portuguese ðŸ‡§ðŸ‡·](README_PT-BR.MD)

# ðŸ“¦ K3s Cluster with N8N, Keycloak, and Databases

Lightweight and automated infrastructure with Traefik, Keel, and continuous update support.

This project defines the complete infrastructure for a lightweight cluster using **K3s**, including:

- Automated deployment of middlewares on Traefik
- Database configuration (PostgreSQL and Redis)
- Main applications: N8N and Keycloak
- Continuous image updates via **Keel**

---

## ðŸ“ Directory Structure

```plaintext
infrastructure/
  â”œâ”€â”€ resources/
  â”‚   â”œâ”€â”€ base/
  â”‚   â”‚   â””â”€â”€ namespaces.yaml
  â”‚   â”œâ”€â”€ traefik/
  â”‚   â”‚   â”œâ”€â”€ 01-middleware-redirect-https.yaml
  â”‚   â”‚   â”œâ”€â”€ 02-middleware-secure-headers.yaml
  â”‚   â”‚   â””â”€â”€ 03-middleware-rate-limit.yaml
  â”‚   â””â”€â”€ keel/
  â”‚       â”œâ”€â”€ deployment.yaml
  â”‚       â””â”€â”€ service.yaml
  â”‚
  â”œâ”€â”€ databases/
  â”‚   â”œâ”€â”€ postgres-n8n/
  â”‚   â”‚   â”œâ”€â”€ configmap.yaml
  â”‚   â”‚   â”œâ”€â”€ deployment.yaml
  â”‚   â”‚   â””â”€â”€ service.yaml
  â”‚   â”œâ”€â”€ postgres-keycloak/
  â”‚   â”‚   â”œâ”€â”€ configmap.yaml
  â”‚   â”‚   â”œâ”€â”€ deployment.yaml
  â”‚   â”‚   â””â”€â”€ service.yaml
  â”‚   â””â”€â”€ redis-n8n/
  â”‚       â”œâ”€â”€ configmap.yaml
  â”‚       â”œâ”€â”€ deployment.yaml
  â”‚       â””â”€â”€ service.yaml
  â”‚
applications/
  â”œâ”€â”€ n8n/
  â”‚   â”œâ”€â”€ configmap.yaml
  â”‚   â”œâ”€â”€ deployment.yaml
  â”‚   â”œâ”€â”€ service.yaml
  â”‚   â””â”€â”€ ingressroute.yaml
  â”‚
  â””â”€â”€ keycloak/
      â”œâ”€â”€ configmap.yaml
      â”œâ”€â”€ deployment.yaml
      â”œâ”€â”€ service.yaml
      â””â”€â”€ ingressroute.yaml
```

---

## ðŸš€ Environment Setup

### Prerequisites

- âœ… **K3s installed:**  
  [https://k3s.io](https://k3s.io)  
  Quick installation:

  ```bash
  curl -sfL https://get.k3s.io | sh -
  ```

- âœ… **Make installed (Debian/Ubuntu):**

  ```bash
  sudo apt install make
  ```

- âœ… **Permissions to apply manifests (`kubectl` is included with K3s)**

- âœ… **Project cloned locally**

### Deployment command

At the project root, run:

```bash
make
```

This command applies, in the following order:

1. Namespaces for applications and databases
2. Traefik middlewares
3. Database services with configmaps
4. Applications (N8N and Keycloak)
5. Keel (for automatic image updates)

### Important notes

- The Traefik dashboard is **disabled by default** to avoid unnecessary exposure.
- Database volumes are mapped on disk (hostPath), respecting VPS storage space.
- The environment was built specifically for lightness and native K3s resources, ensuring efficiency and simplicity in management.

---

## ðŸ”„ Image Updates with Keel

- Keel monitors the images used in the `deployment.yaml` files and performs rolling updates automatically when new versions are available.
- Each `deployment.yaml` must contain the following annotation:

  ```yaml
  metadata:
    annotations:
      keel.sh/policy: force
  ```

---

## ðŸ“Œ Final Considerations

This project was designed and validated to run on clusters based on **K3s**, leveraging its built-in resources such as Traefik and simplified local storage. However, it can be adapted for conventional Kubernetes clusters with minimal changes.

For questions or improvements, contributions are welcome!

> **Note:** This infrastructure was planned to run on clusters based on **K3s**, leveraging its built-in resources such as Traefik and simplified local storage.
