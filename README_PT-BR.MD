ðŸ“˜ Esta documentaÃ§Ã£o tambÃ©m estÃ¡ disponÃ­vel em [English ðŸŒ](README.MD)

# ðŸ“¦ Cluster K3s com N8N, Keycloak e Bancos de Dados

Infraestrutura leve e automatizada com Traefik, Keel e suporte a atualizaÃ§Ãµes contÃ­nuas.

Este projeto define a infraestrutura completa para um cluster leve usando **K3s**, incluindo:

- Deploy automatizado de middlewares no Traefik
- ConfiguraÃ§Ã£o de bancos de dados (PostgreSQL e Redis)
- AplicaÃ§Ãµes principais: N8N e Keycloak
- AtualizaÃ§Ã£o contÃ­nua de imagens via **Keel**

---

## ðŸ“ Estrutura de DiretÃ³rios

```plaintext
infrastructure/
  â”œâ”€â”€ resources/
  â”‚   â”œâ”€â”€ base/
  â”‚   â”‚   â””â”€â”€ namespaces.yaml
  â”‚   â”œâ”€â”€ traefik/
  â”‚   â”‚   â”œâ”€â”€ 01-middleware-redirect-https.yaml
  â”‚   â”‚   â”œâ”€â”€ 02-middleware-secure-headers.yaml
  â”‚   â”‚   â””â”€â”€ 03-middleware-rate-limit.yaml
  â”‚   â””â”€â”€ keel/
  â”‚       â”œâ”€â”€ deployment.yaml
  â”‚       â””â”€â”€ service.yaml
  â”‚
  â”œâ”€â”€ databases/
  â”‚   â”œâ”€â”€ postgres-n8n/
  â”‚   â”‚   â”œâ”€â”€ configmap.yaml
  â”‚   â”‚   â”œâ”€â”€ secret.yaml
  â”‚   â”‚   â”œâ”€â”€ deployment.yaml
  â”‚   â”‚   â””â”€â”€ service.yaml
  â”‚   â”œâ”€â”€ postgres-keycloak/
  â”‚   â”‚   â”œâ”€â”€ configmap.yaml
  â”‚   â”‚   â”œâ”€â”€ secret.yaml
  â”‚   â”‚   â”œâ”€â”€ deployment.yaml
  â”‚   â”‚   â””â”€â”€ service.yaml
  â”‚   â””â”€â”€ redis-n8n/
  â”‚       â”œâ”€â”€ configmap.yaml
  â”‚       â”œâ”€â”€ secret.yaml
  â”‚       â”œâ”€â”€ deployment.yaml
  â”‚       â””â”€â”€ service.yaml
  â”‚
applications/
  â”œâ”€â”€ n8n/
  â”‚   â”œâ”€â”€ configmap.yaml
  â”‚   â”œâ”€â”€ secret.yaml
  â”‚   â”œâ”€â”€ deployment.yaml
  â”‚   â”œâ”€â”€ service.yaml
  â”‚   â””â”€â”€ ingressroute.yaml
  â”‚
  â””â”€â”€ keycloak/
      â”œâ”€â”€ configmap.yaml
      â”œâ”€â”€ secret.yaml
      â”œâ”€â”€ deployment.yaml
      â”œâ”€â”€ service.yaml
      â””â”€â”€ ingressroute.yaml
```

---

## ðŸš€ ExecuÃ§Ã£o do Ambiente

### PrÃ©-requisitos

- âœ… **K3s instalado:**  
  [https://k3s.io](https://k3s.io)  
  InstalaÃ§Ã£o rÃ¡pida:

  ```bash
  curl -sfL https://get.k3s.io | sh -
  ```

- âœ… **Make instalado (Debian/Ubuntu):**

  ```bash
  sudo apt install make
  ```

- âœ… **PermissÃµes para aplicar manifests (`kubectl` jÃ¡ incluso com K3s)**

- âœ… **Projeto clonado localmente**

### Comando de implantaÃ§Ã£o

Na raiz do projeto, execute:

```bash
make
```

Este comando aplica, na seguinte ordem:

1. Namespaces para aplicaÃ§Ãµes e bancos
2. Middlewares do Traefik
3. ServiÃ§os de banco de dados com configmaps
4. AplicaÃ§Ãµes (N8N e Keycloak)
5. Keel (para atualizaÃ§Ã£o automÃ¡tica de imagens)

### ObservaÃ§Ãµes importantes

- O painel do Traefik estÃ¡ **desativado por padrÃ£o** para evitar exposiÃ§Ã£o desnecessÃ¡ria.
- Os volumes dos bancos de dados sÃ£o mapeados em disco (hostPath), respeitando o espaÃ§o da VPS.
- O ambiente foi construÃ­do pensando especificamente na leveza e nos recursos nativos do K3s, garantindo eficiÃªncia e simplicidade no gerenciamento.

---

## ðŸ”„ AtualizaÃ§Ãµes de Imagens com Keel

- O Keel monitora as imagens usadas no `deployment.yaml` e realiza _rolling updates_ automaticamente quando hÃ¡ novas versÃµes.
- Cada `deployment.yaml` deve conter a seguinte anotaÃ§Ã£o:

  ```yaml
  metadata:
    annotations:
      keel.sh/policy: force
  ```

---

## ðŸ“Œ ConsideraÃ§Ãµes Finais

Este projeto foi idealizado e validado para rodar em clusters baseados em **K3s**, aproveitando seus recursos embutidos como o Traefik e o armazenamento local simplificado. Contudo, pode ser adaptado para clusters Kubernetes convencionais com mÃ­nimas alteraÃ§Ãµes.

Para dÃºvidas ou melhorias, contribuiÃ§Ãµes sÃ£o bem-vindas!

> **Nota:** Esta infraestrutura foi planejada para rodar em clusters baseados em **K3s**, aproveitando seus recursos embutidos como o Traefik e o armazenamento local simplificado.
